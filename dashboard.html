<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>صيدلية الرازي — توصيل وصفتي</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="icon" href="razi-logo.png">
<style>html,body{height:100%;background:#f8fafc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}</style>
</head>

<body class="text-slate-900">
<audio id="ding" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAAAABkAAAA"></audio>
<header class="p-4 border-b bg-white flex items-center justify-between">
  <div class="flex items-center gap-3">
    <img src="razi-logo.png" alt="شعار الرازي" class="h-12">
    <div>
      <div class="text-lg font-bold">لوحة التحكم — الطلبات (محلي)</div>
      <div id="conn" class="text-xs text-slate-500">الاتصال: —</div>
    </div>
  </div>
  <div class="flex items-center gap-2">
    <button id="exportBtn" class="rounded-2xl bg-slate-900 text-white px-3 py-2 text-sm">تصدير CSV</button>
    <button id="clearBtn" class="rounded-2xl bg-slate-100 text-slate-900 px-3 py-2 text-sm">حذف الكل</button>
    <div class="text-sm">إجمالي: <b id="total">0</b></div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4">
  <div class="overflow-auto rounded-2xl border">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-2 text-right">التاريخ</th>
          <th class="p-2 text-right">الاسم</th>
          <th class="p-2 text-right">الجوال</th>
          <th class="p-2 text-right">رقم الهوية</th>
          <th class="p-2 text-right">رقم الوصفة</th>
          <th class="p-2 text-right">العنوان</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
const key = 'razi_orders';
const conn = document.getElementById('conn');
const tbody = document.getElementById('tbody');
const totalEl = document.getElementById('total');
const ding = document.getElementById('ding');
const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('razi_orders') : null;

function getOrders(){ try { return JSON.parse(localStorage.getItem(key)||'[]'); } catch { return []; } }
function render(){
  const list = getOrders();
  tbody.innerHTML = '';
  list.forEach(o => {
    const tr = document.createElement('tr');
    tr.className='odd:bg-white even:bg-slate-50';
    tr.innerHTML = `<td class="p-2">${new Date(o.created_at).toLocaleString()}</td>
                    <td class="p-2">${o.full_name}</td>
                    <td class="p-2">${o.phone}</td>
                    <td class="p-2">${o.national_id}</td>
                    <td class="p-2">${o.rx_number}</td>
                    <td class="p-2">${o.address}</td>`;
    tbody.appendChild(tr);
  });
  totalEl.textContent = String(list.length);
}

render();
conn.textContent = 'الاتصال: ' + (bc ? 'نشط (نفس المتصفح/الجهاز)' : 'غير مدعوم');

window.addEventListener('storage', (e)=>{ if (e.key === key) render(); });
if (bc){
  bc.addEventListener('message', (e)=>{
    if (e.data?.type==='NEW_ORDER'){ render(); try{ ding.currentTime=0; ding.play(); }catch(e){} }
  });
}

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const list = getOrders();
  const headers = ['created_at','full_name','phone','national_id','rx_number','address'];
  const rows = list.map(o => [o.created_at,o.full_name,o.phone,o.national_id,o.rx_number,o.address]);
  const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='orders.csv'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  if (!confirm('متأكد من حذف جميع الطلبات المخزنة محليًا؟')) return;
  localStorage.removeItem(key); render();
});
</script>
</body>
</html>
